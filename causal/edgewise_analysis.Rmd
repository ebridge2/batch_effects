---
title: "edgewise_analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
require(ggplot2)
require(energy)
require(parallel)
require(tidyverse)
require(mltools)
ncores <- parallel::detectCores() - 1

```



```{r}
meth.ord <- c("Raw", "ComBat", "Conditional ComBat", "conditional NeuroH", "Causal ComBat", "causal NeuroH")
row.ord <- c("All", "American Clique")
outputs <- readRDS('../data/dcorr/outputs_edgewise_ss_CoRR.rds') %>%
  rbind(readRDS('../data/dcorr/outputs_edgewise_all_CoRR.rds')) %>%
  ungroup() %>%
  mutate(p.value=p.adjust(p.value, method="BH")) %>%
  group_by(Method, Set) %>%
  arrange(p.value, desc(Statistic)) %>%
  mutate(Rank=row_number()) %>%
  mutate(Set=recode_factor(Set, "Causal Subset"="American Clique"),
         Method=recode_factor(Method, "causal ComBat"="Causal ComBat", "conditional ComBat"="Conditional ComBat")) %>%
  mutate(Method=factor(Method, levels=meth.ord, ordered = TRUE),
         Set=factor(Set, levels=row.ord, ordered=TRUE)) %>%
  ungroup() %>%
  filter(!grepl("NeuroH", Method))
```

```{r}
dice <- function(a, b) {
  length(intersect(a, b))/length(union(a, b))
}

overlap_dice <- function(X) {
  methods = unique(X$Method)
  Dice=sapply(unique(X$Method), function(meth1) {
    sapply(unique(X$Method), function(meth2) {
      suppressMessages(
        dice((X %>% filter(Method == meth1) %>% ungroup())$Edge, 
             (X %>% filter(Method == meth2) %>% ungroup())$Edge))
    })
  })
  colnames(Dice) <- rownames(Dice) <- unique(X$Method)
  data.frame(Method1=colnames(Dice)[col(Dice)], Method2=rownames(Dice)[row(Dice)],
             DICE=c(Dice)) %>%
    mutate(Method1=factor(Method1, levels=meth.ord, ordered=TRUE),
           Method2=factor(Method2, levels=meth.ord, ordered=TRUE)) %>%
    arrange(Method1, Method2)
}

n.rank <- 100
dice.mtx.lng <- outputs %>%
  filter((Method == "Raw" & Set == "All") | (Method == "ComBat" & Set == "All") |
           (Method == "Conditional ComBat" & Set == "All") | (Method == "conditional NeuroH" & Set == "All") |
           (Method == "Causal ComBat" & Set == "American Clique") | (Method == "causal NeuroH" & Set  == "American Clique")) %>%
  filter(Rank <= n.rank) %>%
  overlap_dice()

dice.plt <- dice.mtx.lng %>%
  filter(Method1 != Method2) %>%
  ggplot(aes(x=Method1, y=Method2, fill=DICE)) +
    geom_tile() +
    scale_fill_gradient(low="red", high="darkgreen", limits=c(0, 1)) +
    xlab("Method") +
    ylab("Method") +
    ggtitle(sprintf("(C) DICE Overlap of Top %d Edges", n.rank)) +
    theme_bw() + 
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
```

```{r, fig.width=10, fig.height=3}
alpha <- .05

lseq <- function(from=1, to=100000, length.out=6) {
  # logarithmic spaced sequence
  # blatantly stolen from library("emdbook"), because need only this
  unique(floor(round(exp(seq(log(from), log(to), length.out = length.out)), digits=5)))
}

n.breaks <- lseq(from=1, to=6670, length.out=15)
n.rep <- 1000
res.tmp <- lapply(n.breaks, function(n) {
  res.n <- outputs %>%
    filter((Method == "Raw" & Set == "All") | (Method == "ComBat" & Set == "All") |
             (Method == "Conditional ComBat" & Set == "All") | (Method == "conditional NeuroH" & Set == "All") |
             (Method == "Causal ComBat" & Set == "American Clique") | (Method == "causal NeuroH" & Set  == "American Clique")) %>%
    filter(Rank <= n) %>%
    overlap_dice() %>%
    filter(Method2 == "Causal ComBat" & Method1 != "Causal ComBat") %>%
    select(Method1, DICE) %>%
    mutate(n=n) %>%
    rename(Method=Method1)
  
  res.rand <- do.call(rbind, lapply(1:n.rep, function(i) {
    dice((outputs %>% 
            filter(Method == "Causal ComBat" & Set == "American Clique") %>% 
            filter(Rank <= n))$Edge,
         sample(unique(outputs$Edge), size=n, replace=FALSE))
  }))
  
  rand.dat <- data.frame(Method="Random", n=n, ymin=quantile(res.rand, .005),
                         ymax=quantile(res.rand, .995))
  
  res.n <- rbind(res.n, data.frame(Method="Random", n=n,
                                   DICE=mean(res.rand)))
  
  return(list(all=res.n, rand=rand.dat))
})

res.ns <- do.call(rbind, lapply(res.tmp, function(tmp) tmp$all))
res.rands <- do.call(rbind, lapply(res.tmp, function(tmp) tmp$rand))

plt.n <- res.ns %>%
  ggplot() +
  geom_ribbon(data=res.rands, aes(x=n, ymin=ymin, ymax=ymax), color='grey', alpha=.4) +
  geom_line(size=1.2, aes(x=n, y=DICE, color=Method, linetype=Method)) +
  scale_linetype_manual(values=c("Random"=1, "Raw"=1, "ComBat"=1, "Conditional ComBat"=2)) +
  scale_x_continuous(trans="log", breaks=c(1, 10, 100, 1000)) +
  scale_color_manual(values=c("Random"="#e41a1c", "Raw"="#984ea3", "ComBat"="#377eb8", "Conditional ComBat"="#ff7f00")) +
  xlab("Number of Edges") +
  ylab("DICE Overlap") +
  ggtitle("(B) Overlap of Top n Edges Compared to Causal ComBat") +
  theme_bw()

boxes.cmp <- data.frame(xmin=1, ymin=1, xmax=116, ymax=116, Method=c("Raw", "ComBat", "Conditional ComBat", "Causal ComBat")) %>%
  mutate(Set=c("All", "All", "All", "American Clique"), Color="Included") %>%
  rbind(data.frame(xmin=1, ymin=1, xmax=116, ymax=116, Method="Causal ComBat", Set="All", Color="Not Possible")) %>%
  mutate(Method=factor(Method, levels=meth.ord, ordered = TRUE))
  
plt.sig <- outputs %>%
  rbind(outputs %>%
          mutate(Row.Tmp=Row, Row = Column, Column=Row.Tmp) %>% select(-Row.Tmp)) %>%
  filter(p.value <= alpha) %>% # & Rank <= n.rank) %>%
  ggplot() +
  geom_tile(aes(x=Row, y=Column, alpha=rev(Rank), fill=Rank)) +
  geom_rect(data=boxes.cmp, aes(xmin=xmin, ymin=ymin, xmax=xmax, ymax=ymax, color=Color), fill=NA) +
  scale_fill_gradient(name="Rank", low="#530481", high="#fdf2fe") +
  scale_alpha_continuous() +
  scale_color_manual("", values=c("Included"="#4daf4a", "Not Possible"="#e41a1c")) +
  ggtitle(sprintf("(A) Comparison of Significant Edges based on Correction Technique", n.rank)) +
  scale_x_discrete(breaks=c(1, 116), name="Parcel") +
  scale_y_discrete(breaks=c(1, 116), name="Parcel") +
  facet_grid("Set~Method") +
  guides(alpha=FALSE) +
  theme_bw()
```

```{r, fig.height=8.22, fig.width=10.57}
grid.arrange(plt.sig, arrangeGrob(plt.n, dice.plt, nrow=1, widths=c(.5, .35)), nrow=2, heights=c(.3, .2))
```